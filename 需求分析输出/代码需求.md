# 代码需求文档

> 生成时间：2026-02-28

---

## 技术栈

| 项目 | 选择 |
|------|------|
| 游戏引擎 | Cocos Creator 3.x |
| 编程语言 | TypeScript |
| 版本控制 | Git |

---

## 核心系统

### 系统清单

| ID | 系统名称 | 描述 | 优先级 |
|----|----------|------|--------|
| sys_001 | 游戏管理器 | 游戏流程控制 | P0 |
| sys_002 | 输入管理器 | 输入统一处理 | P0 |
| sys_003 | 场景管理器 | 场景切换控制 | P0 |
| sys_004 | 战斗系统 | 战斗逻辑处理 | P0 |
| sys_005 | 角色系统 | 玩家角色控制 | P0 |
| sys_006 | 敌人AI系统 | 敌人行为控制 | P0 |
| sys_007 | 副本系统 | 副本流程管理 | P0 |
| sys_008 | 物品系统 | 物品/装备管理 | P1 |
| sys_009 | 经济系统 | 货币与交易 | P1 |
| sys_010 | 存档系统 | 数据持久化 | P1 |
| sys_011 | 音频系统 | 音频播放控制 | P1 |
| sys_012 | 对话系统 | 对话显示与交互 | P1 |
| sys_013 | 任务系统 | 任务追踪管理 | P2 |

---

## 系统详细需求

### 游戏管理器 (GameManager)

**功能描述：** 游戏整体流程控制，状态管理

**状态定义：**
| 状态 | 说明 |
|------|------|
| LOADING | 加载中 |
| MENU | 主菜单 |
| CHARACTER_SELECT | 角色选择 |
| PLAYING | 游戏中 |
| DIALOG | 对话中 |
| INVENTORY | 背包界面 |
| PAUSED | 暂停 |
| GAMEOVER | 游戏结束 |

**接口需求：**
```typescript
interface GameManager {
    // 获取单例
    getInstance(): GameManager;

    // 获取当前状态
    getState(): GameState;

    // 切换状态
    changeState(state: GameState): void;

    // 切换场景
    loadScene(sceneName: string): Promise<void>;

    // 暂停/恢复游戏
    pause(): void;
    resume(): void;

    // 获取当前玩家
    getCurrentPlayer(): Player;

    // 获取货币数量
    getCurrency(): number;

    // 修改货币
    modifyCurrency(amount: number): void;
}
```

---

### 输入管理器 (InputManager)

**功能描述：** 统一处理键盘、鼠标输入，支持按键重映射

**输入映射：**
| 动作 | 默认按键 | 说明 |
|------|----------|------|
| move_up | W / ↑ | 向上移动 |
| move_down | S / ↓ | 向下移动 |
| move_left | A / ← | 向左移动 |
| move_right | D / → | 向右移动 |
| dodge | Space | 闪避/翻滚 |
| attack | LeftMouse | 普通攻击 |
| skill_1 | Q | 技能1 |
| skill_2 | E | 技能2 |
| ultimate | RightMouse | 终极技能 |
| reload_meditate | R | 换弹/冥想 |
| interact | F | 交互/拾取 |

**接口需求：**
```typescript
interface InputManager {
    // 获取单例
    getInstance(): InputManager;

    // 获取移动方向（归一化向量）
    getMovement(): Vec2;

    // 获取鼠标世界坐标
    getMouseWorldPosition(): Vec2;

    // 获取鼠标屏幕坐标
    getMouseScreenPosition(): Vec2;

    // 检测按键状态
    isKeyPressed(action: string): boolean;
    isKeyDown(action: string): boolean;
    isKeyUp(action: string): boolean;

    // 注册回调
    onAction(action: string, callback: Function): void;
    offAction(action: string, callback: Function): void;

    // 按键重映射
    remapKey(action: string, newKey: KeyCode): void;
}
```

---

### 战斗系统 (CombatSystem)

**功能描述：** 处理战斗逻辑、伤害计算、状态效果

**核心功能：**
| 功能 | 描述 |
|------|------|
| 伤害计算 | 基础伤害、暴击、防御减伤 |
| 伤害类型 | 物理、魔法、真实伤害 |
| 状态效果 | 中毒、灼烧、减速、流血、辐射 |
| 范围检测 | 单体、范围、扇形、直线 |

**伤害公式：**
```
最终伤害 = 基础伤害 × (1 - 防御减伤率) × 暴击倍率 × 抗性系数
防御减伤率 = 防御力 / (防御力 + 100)
暴击倍率 = 暴击时为1.5，否则为1.0
```

**接口需求：**
```typescript
interface CombatSystem {
    // 造成伤害
    dealDamage(attacker: Unit, target: Unit, damage: DamageData): DamageResult;

    // 治疗
    heal(target: Unit, amount: number): void;

    // 应用状态效果
    applyEffect(target: Unit, effect: StatusEffect): void;

    // 移除状态效果
    removeEffect(target: Unit, effectId: string): void;

    // 范围伤害
    dealAreaDamage(center: Vec2, radius: number, damage: DamageData, exclude?: Unit[]): void;

    // 扇形伤害
    dealSectorDamage(origin: Vec2, direction: Vec2, angle: number, range: number, damage: DamageData): void;

    // 检测碰撞
    checkHit(attacker: Unit, target: Unit, hitbox: Hitbox): boolean;
}

interface DamageData {
    baseDamage: number;
    damageType: 'physical' | 'magical' | 'true';
    critChance?: number;
    effects?: StatusEffect[];
    knockback?: number;
}

interface StatusEffect {
    id: string;
    type: 'poison' | 'burn' | 'slow' | 'bleed' | 'radiation';
    duration: number;
    value: number;
    tickInterval?: number;
}
```

---

### 角色系统 (CharacterSystem)

**功能描述：** 玩家角色控制、属性管理、技能系统

**角色属性：**
| 属性 | 说明 |
|------|------|
| HP | 生命值 |
| MP | 魔法值（魔法主角） |
| ATK | 攻击力 |
| DEF | 防御力 |
| SPD | 移动速度 |
| CRIT_RATE | 暴击率 |
| CRIT_DAMAGE | 暴击伤害 |

**角色类型：**
| 类型 | 特点 |
|------|------|
| 科技主角 | 近战为主、外骨骼机甲、需要换弹 |
| 魔法主角 | 远程魔法、需要冥想恢复MP |

**接口需求：**
```typescript
interface Player {
    // 基础属性
    id: string;
    type: 'tech' | 'magic';
    stats: PlayerStats;

    // 移动
    move(direction: Vec2): void;
    dodge(): void;

    // 攻击
    attack(): void;
    useSkill(skillId: string): void;
    useUltimate(): void;

    // 特殊操作
    reload(): void;      // 科技主角
    meditate(): void;    // 魔法主角

    // 交互
    interact(): void;

    // 状态
    takeDamage(damage: number): void;
    heal(amount: number): void;
    die(): void;
}

interface PlayerStats {
    maxHp: number;
    currentHp: number;
    maxMp?: number;        // 魔法主角
    currentMp?: number;    // 魔法主角
    atk: number;
    def: number;
    spd: number;
    critRate: number;
    critDamage: number;
}
```

---

### 敌人AI系统 (EnemyAISystem)

**功能描述：** 敌人行为控制、状态机管理

**AI状态：**
| 状态 | 说明 |
|------|------|
| IDLE | 待机 |
| PATROL | 巡逻 |
| CHASE | 追击 |
| ATTACK | 攻击 |
| FLEE | 逃跑（低血量） |
| ENRAGE | 狂暴（精英怪） |

**接口需求：**
```typescript
interface EnemyAI {
    // 初始化
    init(enemy: Enemy, config: AIConfig): void;

    // 更新
    update(dt: number): void;

    // 状态切换
    changeState(state: AIState): void;

    // 检测玩家
    detectPlayer(): Player | null;

    // 路径寻找
    findPath(target: Vec2): Vec2[];

    // 行为执行
    executeBehavior(): void;
}

interface AIConfig {
    detectRange: number;      // 检测范围
    attackRange: number;      // 攻击范围
    patrolRange: number;      // 巡逻范围
    fleeHealthPercent: number; // 逃跑血量阈值
    enrageHealthPercent?: number; // 狂暴血量阈值（精英）
}
```

---

### 副本系统 (DungeonSystem)

**功能描述：** 副本流程管理、房间生成、通关判定

**房间结构：**
```
入口 → [普通房] → [普通房] → [精英房] → [普通房] → [Boss房] → 通关
                      ↓
                 [隐藏房]（需特殊条件）
```

**接口需求：**
```typescript
interface DungeonSystem {
    // 初始化副本
    initDungeon(dungeonId: string): void;

    // 进入房间
    enterRoom(roomId: string): void;

    // 房间完成
    completeRoom(): void;

    // 检查隐藏房条件
    checkHiddenRoomCondition(): boolean;

    // 副本通关
    completeDungeon(): void;

    // 获取当前房间
    getCurrentRoom(): DungeonRoom;

    // 获取副本进度
    getProgress(): DungeonProgress;
}

interface DungeonRoom {
    id: string;
    type: 'entrance' | 'normal' | 'elite' | 'boss' | 'hidden';
    enemies: EnemySpawn[];
    completed: boolean;
    doors: Door[];
    rewards?: Reward[];
}

interface EnemySpawn {
    enemyId: string;
    position: Vec2;
    spawnDelay?: number;
}
```

---

### 经济系统 (EconomySystem)

**功能描述：** 货币管理、交易系统

**货币设定：**
| 货币 | 说明 |
|------|------|
| 小口径子弹 | 通用货币，用于购买物品/服务 |

**货币获取：**
- 完成任务
- 击杀怪物 → 获得精粹 → 商人兑换
- 击杀人形敌人 → 直接获得

**接口需求：**
```typescript
interface EconomySystem {
    // 获取货币数量
    getCurrency(): number;

    // 增加货币
    addCurrency(amount: number, source?: string): void;

    // 消费货币
    spendCurrency(amount: number): boolean;

    // 检查是否足够
    canAfford(amount: number): boolean;

    // 交易
    trade(itemId: string, quantity: number): TradeResult;
}

interface TradeResult {
    success: boolean;
    message: string;
    remainingCurrency?: number;
}
```

---

## 组件需求

### 角色组件 (Character)

| 功能 | 描述 |
|------|------|
| 属性管理 | HP、MP、ATK、DEF、SPD等 |
| 移动控制 | 8方向移动、速度控制、边界检测 |
| 动画控制 | 状态机驱动的动画切换 |
| 战斗功能 | 攻击、受伤、死亡 |
| 技能管理 | 技能冷却、MP消耗 |

### 敌人AI组件 (EnemyAI)

| 功能 | 描述 |
|------|------|
| 巡逻 | 默认巡逻行为 |
| 追击 | 检测到玩家后追击 |
| 攻击 | 攻击范围内的攻击行为 |
| 逃跑 | 低血量时的逃跑行为 |
| 狂暴 | 精英怪低血量时的强化行为 |

### 可交互组件 (Interactable)

| 功能 | 描述 |
|------|------|
| 交互检测 | 检测玩家进入交互范围 |
| 交互提示 | 显示交互提示UI |
| 交互执行 | 执行交互逻辑 |

---

## 数据配置需求

### 配置文件清单

| 文件名 | 用途 | 格式 |
|--------|------|------|
| game_config.json | 游戏全局配置 | JSON |
| players.json | 玩家角色属性配置 | JSON |
| enemies.json | 敌人属性配置 | JSON |
| skills.json | 技能数据配置 | JSON |
| items.json | 物品数据配置 | JSON |
| dungeons.json | 副本配置 | JSON |
| maps.json | 地图配置 | JSON |
| dialogs/ | 对话数据目录 | JSON |

---

## 目录结构

```
wasteland-battle/
├── assets/
│   ├── sprites/
│   │   ├── players/
│   │   │   ├── player_001/       # 科技主角
│   │   │   └── player_002/       # 魔法主角
│   │   ├── enemies/
│   │   │   ├── animal/           # 动物类怪物
│   │   │   └── plant/            # 植物类怪物
│   │   ├── npcs/
│   │   ├── ui/
│   │   └── effects/
│   ├── audio/
│   │   ├── bgm/
│   │   ├── sfx/
│   │   └── ambient/
│   ├── maps/
│   │   ├── towns/
│   │   ├── wasteland/
│   │   ├── forest/
│   │   ├── ruins/
│   │   └── snow/
│   └── fonts/
├── scripts/
│   ├── core/
│   │   ├── GameManager.ts
│   │   ├── InputManager.ts
│   │   ├── SceneManager.ts
│   │   ├── CombatSystem.ts
│   │   ├── EconomySystem.ts
│   │   └── AudioManager.ts
│   ├── character/
│   │   ├── Player.ts
│   │   ├── PlayerController.ts
│   │   ├── PlayerStats.ts
│   │   └── SkillManager.ts
│   ├── enemy/
│   │   ├── Enemy.ts
│   │   ├── EnemyAI.ts
│   │   └── EnemySpawner.ts
│   ├── dungeon/
│   │   ├── DungeonManager.ts
│   │   ├── Room.ts
│   │   └── RoomGenerator.ts
│   ├── ui/
│   │   ├── MainMenu.ts
│   │   ├── GameHUD.ts
│   │   ├── DialogUI.ts
│   │   ├── InventoryUI.ts
│   │   └── PauseMenu.ts
│   ├── data/
│   │   ├── ConfigLoader.ts
│   │   └── types.ts
│   └── utils/
│       ├── MathUtils.ts
│       └── ObjectPool.ts
├── resources/
│   ├── data/
│   │   ├── game_config.json
│   │   ├── players.json
│   │   ├── enemies.json
│   │   ├── skills.json
│   │   ├── items.json
│   │   └── dungeons.json
│   └── prefabs/
│       ├── players/
│       ├── enemies/
│       ├── items/
│       └── effects/
└── scenes/
    ├── Main.unity
    ├── Town_Knight.unity
    ├── Town_Magic.unity
    ├── Wasteland.unity
    ├── Forest.unity
    ├── Ruins.unity
    ├── Snow.unity
    └── Dungeon/
        ├── Cave.unity
        └── ...
```

---

## 开发优先级

| 阶段 | 内容 | 系统依赖 | 预计工时 |
|------|------|----------|----------|
| P0 | 核心框架 + 基础战斗 | - | 2周 |
| P0 | 玩家角色系统 | P0框架 | 1周 |
| P0 | 敌人AI系统 | P0框架 | 1周 |
| P0 | 副本系统 | P0战斗 | 1周 |
| P1 | 物品/经济系统 | P0 | 1周 |
| P1 | 存档系统 | P0 | 3天 |
| P1 | 音频系统 | P0 | 3天 |
| P1 | 对话系统 | P0 | 1周 |
| P2 | 任务系统 | P1 | 1周 |
| P3 | 优化 + 扩展功能 | P0, P1, P2 | 2周 |

---

## Demo版本功能清单 (P0)

| 功能 | 状态 | 说明 |
|------|------|------|
| 主菜单 | 待开发 | 新游戏/设置/退出 |
| 角色选择 | 待开发 | 选择科技/魔法主角 |
| 基础移动 | 待开发 | WASD移动 + 空格闪避 |
| 基础攻击 | 待开发 | 鼠标左键攻击 |
| 技能系统 | 待开发 | Q/E/右键技能 |
| 敌人AI | 待开发 | 巡逻/追击/攻击 |
| 伤害系统 | 待开发 | HP计算/受伤/死亡 |
| 单个场景 | 待开发 | 废土荒地 |
| 1个副本 | 待开发 | 废土洞穴 |
| 1个Boss | 待开发 | 待设计 |
| 游戏HUD | 待开发 | HP/技能显示 |
