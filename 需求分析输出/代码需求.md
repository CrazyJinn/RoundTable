# 代码需求文档

> 生成时间：2026-02-25
> 来源文档：点子王.md

---

## 技术栈

| 项目 | 选择 |
|------|------|
| 游戏引擎 | Cocos Creator 3.x / Godot 4.x（推荐） |
| 编程语言 | TypeScript / GDScript |
| 版本控制 | Git |
| 资源管理 | JSON配置文件 |

---

## 核心系统

### 系统清单

| ID | 系统名称 | 描述 | 优先级 |
|----|----------|------|--------|
| sys_001 | 游戏管理器 | 游戏流程控制、状态管理 | P0 |
| sys_002 | 输入管理器 | 键盘、鼠标输入统一处理 | P0 |
| sys_003 | 场景管理器 | 场景切换、加载控制 | P0 |
| sys_004 | 战斗系统 | 伤害计算、技能释放、状态效果 | P0 |
| sys_005 | 角色系统 | 玩家角色控制、属性管理 | P0 |
| sys_006 | 敌人AI系统 | 敌人行为、巡逻、追击、攻击 | P0 |
| sys_007 | 对话系统 | 对话显示、选项分支、事件触发 | P1 |
| sys_008 | 背包系统 | 物品管理、使用、装备 | P1 |
| sys_009 | 商店系统 | 购买、出售物品 | P1 |
| sys_010 | 存档系统 | 数据持久化、存档读取 | P1 |
| sys_011 | 音频系统 | BGM、SFX播放控制 | P1 |
| sys_012 | 任务系统 | 任务追踪、完成检测 | P2 |

---

## 系统详细需求

### 游戏管理器 (GameManager)

**功能描述：** 游戏整体流程控制，全局状态管理

**状态定义：**
| 状态 | 说明 |
|------|------|
| LOADING | 加载中 |
| MENU | 主菜单 |
| CHARACTER_SELECT | 角色选择 |
| PLAYING | 游戏中（探索） |
| BATTLE | 战斗中 |
| DIALOG | 对话中 |
| INVENTORY | 背包界面 |
| PAUSED | 暂停 |
| GAMEOVER | 游戏结束 |

**接口需求：**
```typescript
interface GameManager {
    // 获取单例
    getInstance(): GameManager;

    // 状态管理
    getState(): GameState;
    changeState(state: GameState): void;

    // 场景管理
    loadScene(sceneName: string): Promise<void>;
    getCurrentScene(): string;

    // 游戏控制
    pause(): void;
    resume(): void;

    // 角色管理
    getCurrentCharacter(): PlayerCharacter;
    setCurrentCharacter(character: PlayerCharacter): void;

    // 数据管理
    getGameData(): GameData;
    saveGame(): Promise<void>;
    loadGame(slot: number): Promise<void>;
}
```

---

### 输入管理器 (InputManager)

**功能描述：** 统一处理键盘、鼠标输入，支持按键重映射

**输入映射：**
| 动作 | 默认按键 | 说明 |
|------|----------|------|
| move_up | W / ↑ | 向上移动 |
| move_down | S / ↓ | 向下移动 |
| move_left | A / ← | 向左移动 |
| move_right | D / → | 向右移动 |
| dodge | Space | 闪避/翻滚 |
| attack | LeftMouse | 普通攻击 |
| skill_1 | Q | 技能1 |
| skill_2 | E | 技能2 |
| ultimate | RightMouse | 终极技能 |
| reload | R | 换弹/冥想 |
| interact | F | 交互/拾取 |
| inventory | I / Tab | 打开背包 |
| pause | Escape | 暂停菜单 |

**接口需求：**
```typescript
interface InputManager {
    // 单例
    getInstance(): InputManager;

    // 移动输入
    getMovement(): Vector2;  // 返回标准化移动向量

    // 鼠标输入
    getMousePosition(): Vector2;
    getMouseWorldPosition(): Vector2;
    getMouseDelta(): Vector2;

    // 按键状态
    isKeyPressed(action: string): boolean;
    isKeyDown(action: string): boolean;
    isKeyUp(action: string): boolean;

    // 事件回调
    onAction(action: string, callback: Function): void;
    offAction(action: string, callback: Function): void;

    // 按键重映射
    remapAction(action: string, newKey: string): void;
    getKeyBinding(action: string): string;
}
```

---

### 战斗系统 (CombatSystem)

**功能描述：** 处理战斗逻辑、伤害计算、状态效果

**核心功能：**
| 功能 | 描述 |
|------|------|
| 伤害计算 | 基础伤害、暴击、防御减伤 |
| 伤害类型 | 物理、魔法、真实伤害、辐射伤害 |
| 状态效果 | 中毒、灼烧、减速、冰冻、狂暴 |
| 范围检测 | 单体、圆形范围、扇形、直线 |
| 伤害反馈 | 伤害数字、击退效果、受击闪烁 |

**伤害公式：**
```
物理伤害 = 基础伤害 × (1 - 物理防御减伤率) × 暴击倍率
魔法伤害 = 基础伤害 × (1 - 魔法抗性减伤率) × 暴击倍率
防御减伤率 = 防御力 / (防御力 + 100)
暴击倍率 = 暴击时 1.5~2.0，否则 1.0
```

**状态效果：**
| 效果 | 持续时间 | 效果描述 |
|------|----------|----------|
| 中毒 | 5秒 | 每秒损失 2% 最大HP |
| 灼烧 | 3秒 | 每秒损失 3% 最大HP |
| 减速 | 3秒 | 移动速度降低 50% |
| 冰冻 | 2秒 | 无法移动和攻击 |
| 辐射 | 10秒 | 每秒损失 1% 最大HP，治疗效果降低 |
| 狂暴 | 持续至战斗结束 | 攻击力+30%，攻速+50% |

**接口需求：**
```typescript
interface CombatSystem {
    // 造成伤害
    dealDamage(attacker: Unit, target: Unit, damage: DamageData): DamageResult;

    // 治疗
    heal(target: Unit, amount: number): void;

    // 应用状态效果
    applyEffect(target: Unit, effect: StatusEffect): void;
    removeEffect(target: Unit, effectId: string): void;
    hasEffect(target: Unit, effectId: string): boolean;

    // 范围伤害
    dealAreaDamage(center: Vector2, radius: number, damage: DamageData, exclude?: Unit[]): void;
    dealSectorDamage(origin: Vector2, direction: Vector2, angle: number, range: number, damage: DamageData): void;

    // 检测
    getUnitsInRange(center: Vector2, radius: number, filter?: UnitFilter): Unit[];
    getNearestTarget(position: Vector2, range: number, filter?: UnitFilter): Unit | null;
}

interface DamageData {
    type: DamageType;        // 物理/魔法/真实/辐射
    amount: number;          // 基础伤害
    canCrit: boolean;        // 是否可暴击
    knockback?: number;      // 击退力度
    effects?: StatusEffect[]; // 附带效果
}

interface DamageResult {
    damage: number;          // 实际伤害
    isCrit: boolean;         // 是否暴击
    isBlocked: boolean;      // 是否被格挡
    isDead: boolean;         // 目标是否死亡
}
```

---

### 角色系统 (CharacterSystem)

**功能描述：** 玩家角色控制、属性管理、技能系统

**角色属性：**
| 属性 | 说明 | 计算方式 |
|------|------|----------|
| HP | 生命值 | 基础值 + 装备加成 |
| MP | 魔法值/弹药 | 基础值 + 装备加成 |
| ATK | 攻击力 | 基础值 + 装备加成 |
| DEF | 防御力 | 基础值 + 装备加成 |
| SPD | 移动速度 | 基础值 + 装备加成 |
| CritRate | 暴击率 | 基础值 + 装备加成 |
| CritDamage | 暴击伤害 | 基础值 + 装备加成 |

**角色类型差异：**
| 特性 | 科技主角 | 魔法主角 |
|------|----------|----------|
| 主属性 | 物理攻击 | 魔法攻击 |
| 资源系统 | 弹药（需换弹） | 魔法值（需冥想） |
| 伤害类型 | 物理 | 魔法 |
| 战斗距离 | 近战为主 | 远程为主 |

**接口需求：**
```typescript
interface PlayerCharacter {
    // 基础信息
    id: string;
    name: string;
    faction: Faction;

    // 属性
    stats: CharacterStats;
    currentHP: number;
    currentMP: number;

    // 技能
    skills: Skill[];
    getSkill(slot: SkillSlot): Skill | null;
    useSkill(slot: SkillSlot, target?: Vector2): boolean;

    // 状态
    isAlive(): boolean;
    isInvincible(): boolean;

    // 移动
    move(direction: Vector2): void;
    dodge(): boolean;

    // 资源
    reload(): void;      // 科技派换弹
    meditate(): void;    // 魔法派冥想

    // 事件
    onDamage: Event<DamageResult>;
    onDeath: Event<void>;
    onLevelUp: Event<number>;
}
```

---

### 敌人AI系统 (EnemyAISystem)

**功能描述：** 敌人行为控制、状态机管理

**AI状态：**
| 状态 | 说明 |
|------|------|
| IDLE | 待机 |
| PATROL | 巡逻 |
| ALERT | 警觉（发现玩家） |
| CHASE | 追击 |
| ATTACK | 攻击 |
| SKILL | 使用技能 |
| FLEE | 逃跑（低血量） |
| DEAD | 死亡 |

**AI行为参数：**
| 参数 | 说明 |
|------|------|
| detectRange | 检测玩家范围 |
| attackRange | 攻击范围 |
| patrolRange | 巡逻范围 |
| chaseSpeed | 追击速度 |
| fleeHealthPercent | 逃跑血量阈值 |

**接口需求：**
```typescript
interface EnemyAI {
    // 状态控制
    getState(): AIState;
    setState(state: AIState): void;

    // 目标管理
    getTarget(): PlayerCharacter | null;
    setTarget(target: PlayerCharacter): void;
    hasLineOfSight(target: PlayerCharacter): boolean;

    // 行为
    patrol(): void;
    chase(target: PlayerCharacter): void;
    attack(target: PlayerCharacter): void;
    flee(): void;

    // 检测
    canSeePlayer(): boolean;
    canAttackTarget(): boolean;
    getDistanceToTarget(): number;

    // 配置
    setBehavior(config: AIBehaviorConfig): void;
}
```

---

### 对话系统 (DialogSystem)

**功能描述：** 对话显示、选项分支、条件检测、事件触发

**核心功能：**
| 功能 | 描述 |
|------|------|
| 对话显示 | 打字机效果、角色名、头像、表情 |
| 选项分支 | 多选项对话分支 |
| 条件检测 | 根据条件显示/隐藏选项或跳转 |
| 事件触发 | 对话中触发游戏事件（获得物品、解锁区域等） |
| 历史记录 | 对话历史查看 |

**数据结构：**
```typescript
interface DialogData {
    id: string;
    npcId: string;
    sections: DialogSection[];
}

interface DialogSection {
    id: string;
    lines: DialogLine[];
    options?: DialogOption[];
    condition?: DialogCondition;
    onComplete?: DialogEvent[];
}

interface DialogLine {
    speaker: string;
    text: string;
    portrait?: string;
    emotion?: string;
    effects?: DialogEffect[];
}

interface DialogOption {
    text: string;
    nextSection: string;
    condition?: DialogCondition;
    onSelect?: DialogEvent[];
}

interface DialogCondition {
    type: 'hasItem' | 'hasFlag' | 'level' | 'faction';
    value: any;
}

interface DialogEvent {
    type: 'giveItem' | 'setFlag' | 'startQuest' | 'teleport' | 'unlockArea';
    data: any;
}
```

---

## 组件需求

### 角色组件 (Character)

| 功能 | 描述 |
|------|------|
| 属性管理 | HP、MP、ATK、DEF、SPD等 |
| 移动控制 | 方向移动、速度控制、翻滚闪避 |
| 动画控制 | 状态机驱动的动画切换 |
| 战斗功能 | 攻击、受伤、死亡、技能释放 |
| 资源管理 | 弹药/魔法值的消耗和恢复 |

### 敌人组件 (Enemy)

| 功能 | 描述 |
|------|------|
| AI状态机 | 巡逻、追击、攻击、逃跑 |
| 属性管理 | HP、ATK、DEF、掉落物 |
| 战斗功能 | 攻击、受伤、死亡、特殊技能 |
| 掉落系统 | 死亡时掉落物品 |

### 交互物组件 (Interactable)

| 功能 | 描述 |
|------|------|
| 拾取物 | 物品、资源的拾取 |
| 传送点 | 场景间传送 |
| 宝箱 | 开启获得物品 |
| NPC | 对话交互 |

### 状态效果组件 (StatusEffectManager)

| 功能 | 描述 |
|------|------|
| 效果管理 | 添加、移除、更新状态效果 |
| 效果叠加 | 同类效果的处理规则 |
| 效果触发 | 定时触发效果（中毒、灼烧等） |

---

## 数据配置需求

### 配置文件清单

| 文件名 | 用途 | 格式 |
|--------|------|------|
| game_config.json | 游戏全局配置 | JSON |
| characters.json | 角色属性配置 | JSON |
| enemies.json | 敌人属性配置 | JSON |
| skills.json | 技能数据配置 | JSON |
| items.json | 物品数据配置 | JSON |
| status_effects.json | 状态效果配置 | JSON |
| dialogs/*.json | 对话数据文件 | JSON |
| scenes/*.json | 场景配置文件 | JSON |

### 配置文件示例

**characters.json:**
```json
{
    "player_001": {
        "name": "科技主角",
        "faction": "knight",
        "stats": {
            "hp": 100,
            "mp": 30,
            "atk": 15,
            "def": 10,
            "spd": 5,
            "critRate": 0.05,
            "critDamage": 1.5
        },
        "skills": ["skill_p1_01", "skill_p1_02", "skill_p1_03", "skill_p1_04"],
        "resourceType": "ammo"
    },
    "player_002": {
        "name": "魔法主角",
        "faction": "arcane",
        "stats": {
            "hp": 80,
            "mp": 100,
            "atk": 20,
            "def": 5,
            "spd": 4,
            "critRate": 0.08,
            "critDamage": 1.8
        },
        "skills": ["skill_p2_01", "skill_p2_02", "skill_p2_03", "skill_p2_04", "skill_p2_05"],
        "resourceType": "mana"
    }
}
```

---

## 目录结构

```
wasteland-battle/
├── assets/
│   ├── sprites/
│   │   ├── characters/
│   │   │   ├── players/
│   │   │   ├── enemies/
│   │   │   └── npcs/
│   │   ├── scenes/
│   │   │   ├── maps/
│   │   │   ├── towns/
│   │   │   └── battles/
│   │   ├── ui/
│   │   └── effects/
│   ├── audio/
│   │   ├── bgm/
│   │   ├── sfx/
│   │   └── ambient/
│   └── fonts/
├── scripts/
│   ├── core/
│   │   ├── GameManager.ts
│   │   ├── InputManager.ts
│   │   ├── SceneManager.ts
│   │   ├── AudioManager.ts
│   │   └── SaveManager.ts
│   ├── systems/
│   │   ├── CombatSystem.ts
│   │   ├── DialogSystem.ts
│   │   ├── InventorySystem.ts
│   │   ├── ShopSystem.ts
│   │   └── QuestSystem.ts
│   ├── components/
│   │   ├── Character.ts
│   │   ├── PlayerController.ts
│   │   ├── EnemyAI.ts
│   │   ├── Interactable.ts
│   │   └── StatusEffectManager.ts
│   ├── data/
│   │   ├── types.ts
│   │   ├── DataLoader.ts
│   │   └── ConfigManager.ts
│   ├── ui/
│   │   ├── HUD.ts
│   │   ├── DialogUI.ts
│   │   ├── InventoryUI.ts
│   │   ├── ShopUI.ts
│   │   └── MenuUI.ts
│   └── utils/
│       ├── MathUtils.ts
│       └── EventBus.ts
├── resources/
│   ├── data/
│   │   ├── game_config.json
│   │   ├── characters.json
│   │   ├── enemies.json
│   │   ├── skills.json
│   │   ├── items.json
│   │   ├── status_effects.json
│   │   └── dialogs/
│   ├── prefabs/
│   │   ├── characters/
│   │   ├── enemies/
│   │   ├── items/
│   │   └── effects/
│   └── scenes/
│       ├── maps/
│       ├── towns/
│       └── battles/
└── package.json
```

---

## 开发优先级

| 阶段 | 内容 | 系统依赖 | 预计工作量 |
|------|------|----------|------------|
| P0-1 | 游戏管理器 + 输入管理器 | - | 核心 |
| P0-2 | 角色系统 + 基础移动 | P0-1 | 核心 |
| P0-3 | 战斗系统 + 伤害计算 | P0-2 | 核心 |
| P0-4 | 敌人AI + 基础怪物 | P0-3 | 核心 |
| P0-5 | 场景管理 + 测试场景 | P0-4 | 核心 |
| P1-1 | 对话系统 + UI系统 | P0 | 重要 |
| P1-2 | 背包系统 + 物品系统 | P0, P1-1 | 重要 |
| P1-3 | 商店系统 + 经济系统 | P1-2 | 重要 |
| P1-4 | 存档系统 | P0, P1-2 | 重要 |
| P1-5 | 音频系统 | P0 | 重要 |
| P2-1 | 任务系统 | P1-1, P1-2 | 次要 |
| P2-2 | 完整战斗（所有怪物） | P0-4 | 次要 |
| P3 | 优化 + 扩展功能 | P0, P1, P2 | 可选 |

---

## 技术要点

### 双主角系统

- 玩家在游戏开始时选择角色
- 不同角色有不同的资源系统（弹药 vs 魔法值）
- 不同角色的操作方式略有差异（换弹 vs 冥想）

### 俯视角控制

- 角色朝向跟随鼠标位置
- 移动方向与朝向独立（可向后移动）
- 技能释放方向由鼠标位置决定

### 战斗节奏

- 攻击有短暂前摇和后摇
- 翻滚有无敌帧
- 技能有冷却时间
- 敌人攻击有预警

### 性能优化

- 对象池管理（子弹、特效、掉落物）
- 视口外敌人AI简化
- 场景分块加载
